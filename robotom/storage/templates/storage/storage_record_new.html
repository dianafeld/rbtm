{% extends "base.html" %}

{% load staticfiles %}
<link rel="stylesheet" href="{% static 'storage/styles.css' %}">

{% block content %}

    <div class="page-header" style="margin-left: 10px">
        <h1>Запись хранилища номер {{ record_id }}</h1>
    </div>
    {% if messages %}
        <div class="row">
            {% for message in messages %}
            <div class="col-sm-6 col-sm-offset-3 col-lg-4 col-lg-offset-3">
                <div class="alert alert-{% if message.tags %}{% if message.tags == "error" %}danger{% else %}{{ message.tags }}{% endif %}{% else %}info{% endif %}">
                    <a class="close" data-dismiss="alert" href="{% url 'storage:index' %}">&times;</a>
                    {{ message }}
                </div>
            </div>
            {% endfor %}
        </div>
    {% endif %}
    {% if to_show %}
        <div class="container">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead>
                            <tr>
                                <th rowspan="2" style="vertical-align: middle">Образец</th>
                                <th rowspan="2" style="vertical-align: middle">Закончен</th>
                                <th rowspan="2" style="vertical-align: middle">Advanced</th>
                                <th colspan="4" style="text-align: center">DATA</th>
                                <th colspan="2" style="text-align: center">EMPTY</th>
                                <th colspan="2" style="text-align: center">DARK</th>
                            </tr>
                            <tr>
                                <th>Angle Step</th>
                                <th>Count per step</th>
                                <th>Step Count</th>
                                <th>Exposure</th>
                                <th>Сount</th>
                                <th>Exposure</th>
                                <th>Count</th>
                                <th>Exposure</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>{{ info.specimen }}</td>
                                <td>{{ info.finished }}</td>
                                <td>{{ info.advanced }}</td>
                                <td>{{ info.data_angle_step }}</td>
                                <td>{{ info.data_count_per_step }}</td>
                                <td>{{ info.data_step_count }}</td>
                                <td>{{ info.data_exposure }}</td>
                                <td>{{ info.empty_count }}</td>
                                <td>{{ info.empty_exposure }}</td>
                                <td>{{ info.dark_count }}</td>
                                <td>{{ info.dark_exposure }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="alert alert-info" id="LoadStatus">Статус загрузки изображений: загружается</div>
        </div>
        <div class="container">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4>Список изображений эксперимента</h4>
                </div>
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead>
                            <tr>
                                <th>Num</th>
                                <th>Type</th>
                                <th>DateTime</th>
                                <th>Exposure</th>
                                <th>Shutter open</th>
                                <th>Angle position</th>
                                <th>X-Ray current</th>
                                <th>X-Ray voltage</th>
                                <th>Detector model</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for frame in frames_list %}
                                <tr class="paginated-content">
                                    <td><a id="{{ frame.num }}" onClick="table_click(this.id)"
                                           href="#">{{ frame.num }}</a></td>
                                    <td>{{ frame.type }}</td>
                                    <td>{{ frame.date_time }}</td>
                                    <td>{{ frame.exposure }}</td>
                                    <td>{{ frame.shutter_open }}</td>
                                    <td>{{ frame.angle_position }}</td>
                                    <td>{{ frame.current }}</td>
                                    <td>{{ frame.voltage }}</td>
                                    <td>{{ frame.detector_model }}</td>
                                    <td hidden>{{ frame.id }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="myModalBox" class="modal fade">
            <div class="modal-dialog">
                <div class="modal-content">
                    <!-- Заголовок модального окна -->
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            <span class="glyphicon glyphicon-remove"></span>
                        </button>
                        <h4 class="modal-title" id="ImageTitle">Изображение</h4>
                    </div>
                    <!-- Основной текст сообщения -->
                    <div class="modal-body" id="modal-body">
                        <button type="button" class="btn btn-default pull-left prev" id="1"
                                onClick="nav_click(this.id)">
                            <i class="glyphicon glyphicon-chevron-left"></i>
                            Previous
                        </button>
                        <button type="button" class="btn btn-default pull-right next" id="1"
                                onClick="nav_click(this.id)">
                            Next
                            <i class="glyphicon glyphicon-chevron-right"></i>
                        </button>
                        <table class="table table-responsive">
                            <thead>
                            <tr>
                                <th>Type</th>
                                <th>Date Time</th>
                                <th>Exposure</th>
                                <th>Shutter open</th>
                                <th>Angle position</th>
                                <th>X-Ray current</th>
                                <th>X-Ray voltage</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td id="Type"></td>
                                <td id="DateTime"></td>
                                <td id="Exposure"></td>
                                <td id="Shutter"></td>
                                <td id="Angle"></td>
                                <td id="Current"></td>
                                <td id="Voltage"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- Нижняя часть модального окна -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default pull-left prev" id="1"
                                onClick="nav_click(this.id)">
                            <i class="glyphicon glyphicon-chevron-left"></i>
                            Previous
                        </button>
                        <button type="button" class="btn btn-default next" id="1" onClick="nav_click(this.id)">
                            Next
                            <i class="glyphicon glyphicon-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    {% endif %}

    <script type="text/javascript">
        function get_id_by_number(number) {
            return document.getElementById(number).parentNode.parentNode.childNodes[19].textContent;
        }

        function remove_image() {
            var mod = document.getElementById('modal-body');
            mod.removeChild(mod.lastElementChild);
        }

        function set_image(clicked_id) {
            var img = document.createElement('img');
            img.className = "img-responsive";
            img.setAttribute('src', "/media/" + get_id_by_number(clicked_id) + ".png");
            var mod_body = document.getElementById('modal-body');
            mod_body.appendChild(img);

            var mod_title = document.getElementById('ImageTitle');
            mod_title.innerText = 'Изображение ' + clicked_id;

            document.getElementById('Type').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[1].textContent;
            document.getElementById('DateTime').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[5].textContent;
            document.getElementById('Exposure').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[7].textContent;
            document.getElementById('Shutter').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[9].textContent;
            document.getElementById('Angle').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[11].textContent;
            document.getElementById('Current').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[13].textContent;
            document.getElementById('Voltage').innerText = document.getElementById(clicked_id).parentNode.parentNode.childNodes[1].textContent;

            var left_button = document.getElementsByClassName('prev')[0];
            if (left_button.id > 0) {
                left_button.id = parseInt(clicked_id) - 1;
            }
            else
                left_button.id = {{ frames_list|length }} -1;
            left_button = document.getElementsByClassName('prev')[1];
            if (left_button.id > 0)
                left_button.id = parseInt(clicked_id) - 1;
            else
                left_button.id = {{ frames_list|length }} -1;
            var right_button = document.getElementsByClassName('next')[0];
            if (right_button.id < {{ frames_list|length }} -1)
                right_button.id = parseInt(clicked_id) + 1;
            else
                right_button.id = 0;
            right_button = document.getElementsByClassName('next')[1];
            if (right_button.id < {{ frames_list|length }} -1)
                right_button.id = parseInt(clicked_id) + 1;
            else
                right_button.id = 0;
        }

        $(document).ready(function () {
            $("#myModalBox").on('hidden.bs.modal', function () {
                remove_image();
            });

            $.ajax({
                url: '{% url 'storage:frames_downloading' record_id %}',
                method: 'GET',
                dataType: 'text',
                success: function (data, textStatus, jqXHR) {
{#                    alert(data + " " + textStatus + " " + jqXHR);#}
                    var status = document.getElementById("LoadStatus");
                    status.innerText = "Статус загрузки сообщений: загружено";
                    status.className = "alert alert-success"

                },
                error: function (jqXHR, textStatus, errorThrown) {
{#                    alert(jqXHR.responseText);#}
                    var status = document.getElementById("LoadStatus");
                    status.innerText = "Статус загрузки сообщений: ошибка";
                    status.className = "alert alert-danger"
                }
            });
        });

        function table_click(clicked_id) {
            set_image(clicked_id);
            $("#myModalBox").modal();
        }

        function nav_click(clicked_id) {
            remove_image();
            table_click(clicked_id);
        }
    </script>
{% endblock content %}